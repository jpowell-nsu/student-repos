name: Add Approved GitHub Account

on:
  issues:
    types: [labeled]

jobs:
  add-account:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue body and extract account URL
        id: parse
        run: |
          # Read the issue body
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          
          # Extract the first non-empty line as the name
          NAME=$(echo "$ISSUE_BODY" | awk '/^### Your name$/ {getline; while($0 ~ /^$/) getline; print; exit}' | xargs)
          
          # Extract the first GitHub user URL
          ACCOUNT_URL=$(echo "$ISSUE_BODY" | grep -Eo 'https://github\.com/[^[:space:]/]+/?' | head -n1)
          
          if [[ -z "$NAME" || -z "$ACCOUNT_URL" ]]; then
            echo "Invalid submission. Name or GitHub URL missing."
            exit 1
          fi
          
          echo "NAME=$NAME" >> $GITHUB_ENV
          echo "ACCOUNT_URL=$ACCOUNT_URL" >> $GITHUB_ENV

      - name: Ensure accounts.json exists
        run: |
          if [ ! -f accounts.json ]; then
            echo '{"accounts":[]}' > accounts.json
          fi

      - name: Add account to accounts.json
        run: |
          # Skip if the account already exists
          if jq -e --arg url "$ACCOUNT_URL" '.accounts[]? | select(.url == $url)' accounts.json >/dev/null; then
            echo "Account already exists. Skipping."
            exit 0
          fi

          # Append the account
          jq --arg name "$NAME" --arg url "$ACCOUNT_URL" \
            '.accounts += [{"name": $name, "url": $url}]' accounts.json > accounts.tmp.json
          mv accounts.tmp.json accounts.json

      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add accounts.json
          git commit -m "Add GitHub account: $ACCOUNT_URL" || echo "No changes to commit"
          git push

      - name: Close issue using GitHub CLI
        run: |
          gh issue close ${{ github.event.issue.number }} \
            --comment "âœ… This GitHub account has been approved and added to the list. Thanks for submitting!"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
