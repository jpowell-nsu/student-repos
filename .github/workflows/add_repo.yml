name: Add approved GitHub account

on:
  issues:
    types: [labeled]

jobs:
  add-account:
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      issues: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Parse issue and update JSON
        run: |
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")

          # Extract the URL from the Markdown template
          ACCOUNT_URL=$(echo "$ISSUE_BODY" | grep -A1 "\*\*GitHub account URL:\*\*" | tail -n1 | sed 's/^[[:space:]]*//')

          # Validate it looks like a GitHub URL
          if [[ -z "$ACCOUNT_URL" || "$ACCOUNT_URL" != https://github.com/* ]]; then
            echo "Invalid account URL: $ACCOUNT_URL"
            exit 1
          fi

          # Check if the account is already listed
          if jq -e --arg url "$ACCOUNT_URL" '.accounts[]? | select(.url == $url)' accounts.json >/dev/null; then
            echo "Account already exists in JSON"
            exit 0
          fi

          # Append to JSON
          jq --arg url "$ACCOUNT_URL" \
            '.accounts += [{"url": $url}]' \
            accounts.json > accounts.tmp.json

          mv accounts.tmp.json accounts.json

      - name: Commit changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add accounts.json
          git commit -m "Add GitHub account: ${{ github.event.issue.title }}" || echo "No changes to commit"
          git push

      - name: Close the issue
        uses: peter-evans/close-issue@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          comment: "This GitHub account has been approved and added to the list."
